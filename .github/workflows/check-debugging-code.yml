name: Check for Debugging Code

on:
    pull_request:
        types: [opened, synchronize, ready_for_review]

jobs:
    check-debugging:
        name: Check for Debugging Code
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Check for PHP Debugging Code
              run: |
                  # Check for PHP debugging patterns, excluding lines with @debug-ignore comment
                  FAILED=0
                  while IFS= read -r file; do
                    # Skip test files
                    if [[ "$file" == *"tests/"* ]]; then
                      continue
                    fi
                    
                    # Get all lines with debugging code
                    while IFS= read -r line; do
                      # Check if line has @debug-ignore comment
                      if ! grep -A1 -B1 "$line" "$file" | grep -q "@debug-ignore"; then
                        # Get line number
                        line_number=$(grep -n "$line" "$file" | cut -d: -f1)
                        # Get context (3 lines before and after)
                        context=$(sed -n "$((line_number-3)),$((line_number+3))p" "$file")
                        
                        echo "::error file=$file,line=$line_number::Found PHP debugging code without @debug-ignore comment"
                        echo "Context:"
                        echo "$context"
                        echo "----------------------------------------"
                        FAILED=1
                      fi
                    done < <(grep -E "(die\(|var_dump\(|print_r\(|error_log\(|wp_die\(|exit\()" "$file")
                  done < <(find . -type f -name "*.php")

                  if [ $FAILED -eq 1 ]; then
                    exit 1
                  fi

            - name: Check for JavaScript Debugging Code
              run: |
                  # Check for JavaScript debugging patterns, excluding lines with @debug-ignore comment
                  FAILED=0
                  while IFS= read -r file; do
                    # Skip test files
                    if [[ "$file" == *"tests/"* ]]; then
                      continue
                    fi
                    
                    # Get all lines with debugging code
                    while IFS= read -r line; do
                      # Check if line has @debug-ignore comment
                      if ! grep -A1 -B1 "$line" "$file" | grep -q "@debug-ignore"; then
                        # Get line number
                        line_number=$(grep -n "$line" "$file" | cut -d: -f1)
                        # Get context (3 lines before and after)
                        context=$(sed -n "$((line_number-3)),$((line_number+3))p" "$file")
                        
                        echo "::error file=$file,line=$line_number::Found JavaScript debugging code without @debug-ignore comment"
                        echo "Context:"
                        echo "$context"
                        echo "----------------------------------------"
                        FAILED=1
                      fi
                    done < <(grep -E "(console\.(log|debug|info|warn|error)|debugger|alert\()" "$file")
                  done < <(find . -type f \( -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" \))

                  if [ $FAILED -eq 1 ]; then
                    exit 1
                  fi

            - name: Check for Skip/Only in Tests
              run: |
                  # Check for .skip or .only in test files, excluding lines with @debug-ignore comment
                  FAILED=0
                  while IFS= read -r file; do
                    # Skip test files
                    if [[ "$file" == *"tests/"* ]]; then
                      continue
                    fi
                    
                    # Get all lines with skip/only
                    while IFS= read -r line; do
                      # Check if line has @debug-ignore comment
                      if ! grep -A1 -B1 "$line" "$file" | grep -q "@debug-ignore"; then
                        # Get line number
                        line_number=$(grep -n "$line" "$file" | cut -d: -f1)
                        # Get context (3 lines before and after)
                        context=$(sed -n "$((line_number-3)),$((line_number+3))p" "$file")
                        
                        echo "::error file=$file,line=$line_number::Found .skip or .only without @debug-ignore comment"
                        echo "Context:"
                        echo "$context"
                        echo "----------------------------------------"
                        FAILED=1
                      fi
                    done < <(grep -E "\.(skip|only)\(" "$file")
                  done < <(find . -type f -name "*.test.*")

                  if [ $FAILED -eq 1 ]; then
                    exit 1
                  fi
